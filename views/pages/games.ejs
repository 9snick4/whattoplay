<!DOCTYPE html>
<html>
<head>
  <% include ../partials/header.ejs %>
  <script>
    function getQueryVariable(variable)
    {
          var query = window.location.search.substring(1);
          var vars = query.split("&");
          for (var i=0;i<vars.length;i++) {
                  var pair = vars[i].split("=");
                  if(pair[0] == variable){return pair[1];}
          }
          return(false);
    }

    function writeGame(item,nightId) {
      var ul = $("<li>").addClass("games");
      var img = $("<img>").attr("src", item.children[3].innerHTML).attr("alt", item.children[0].innerHTML);
      var title = $("<div>").addClass("game-title").text(item.children[0].innerHTML);
      var gameurl = $("<a>").attr("href", "https://boardgamegeek.com/boardgame/" + item.attributes.objectid.value).append(title);
      var button = $("<input type=button>").val("Choose this game").on("click", insertGame(item.attributes.objectid,nightId))
      ul.append(img).append(gameurl).append(button);
      $("#games").append(ul);
    }

    function insertGame(gameID, nightId) {
      // ask for gamername
      //query insert db
      //return result
    }

    function getRetry(night, tries) {
      var username= night.hostusername;
      $.get("https://www.boardgamegeek.com/xmlapi2/collection?own=1&username=" +username)
        .fail(function() {
          if (tries < 10)
            return setTimeout(getRetry,7000,username, tries + 1);
          else
            $("#games").text("Could not retrieve collection.");
            return;
        })
        .done(function(data) {
          for (let index = 0; index < data.children[0].children.length; index++) {
            const item = data.children[0].children[index];
            writeGame(item,night.nightid); //game Name
          }     
        })
      }  
    var night = JSON.parse(decodeURIComponent(getQueryVariable("night")));
    getRetry(night,1);
  </script>
</head>

<body>

<% include ../partials/nav.ejs %>

<div class="container">
<h2>Games</h2>
<ul id = "games">
    
</ul> 

</div id = "choices">

</div>
</body>
</html>
